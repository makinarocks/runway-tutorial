<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Runway object detection serving</title>
	<link rel="stylesheet" href="static/base.css">
	<style>
		/* image container */
		.image {
			position: relative;
		}
		.image img {
			display: block;
			width: 100%;
		}
		.image .object {
			position: absolute;
			outline: 2px solid #000;
		}
		.image .object span {
			position: relative;
			top: -1.45em;
			left: -2px;
			color: #000;
			white-space: pre;
			padding: 0 3px;
		}
		.object.color1 {
			outline-color: #ff004f;
		}
		.object.color1 span {
			background-color: #ff004f;
		}
		.object.color2 {
			outline-color: #ff8200;
		}
		.object.color2 span {
			background-color: #ff8200;
		}
		.object.color3 {
			outline-color: #faff00;
		}
		.object.color3 span {
			background-color: #faff00;
		}
		.object.color4 {
			outline-color: #00de62;
		}
		.object.color4 span {
			background-color: #00de62;
		}
		.object.color5 {
			outline-color: #00e3ff;
		}
		.object.color5 span {
			background-color: #00e3ff;
		}
		.object.color6 {
			outline-color: #0093ff;
		}
		.object.color6 span {
			background-color: #0093ff;
		}
		.object.color7 {
			outline-color: #0030cc;
		}
		.object.color7 span {
			background-color: #0030cc;
		}
		.object.color8 {
			outline-color: #6c00ff;
		}
		.object.color8 span {
			background-color: #6c00ff;
		}
		.object.color9 {
			outline-color: #ff00c3;
		}
		.object.color9 span {
			background-color: #ff00c3;
		}
	</style>
</head>
<body>
	<img id="runway-logo" src="static/runway.svg" alt="Runway">

	<div class="wrap">
		<h1>Object Detection <span>(by API Serving)</span></h1>

		<p class="control">
			<label>
				API endpoint
				<input type="text" name="endpoint" value="http://reverse-proxy-api-2.serving.live.mrxrunway.ai/api/v1/default/inference" required />
			</label>
		</p>
		<p class="control">
			<label>
				API token
				<input type="text" name="token" required />
			</label>
		</p>
		<p class="control">
			<label>
				Target image(jpeg)
				<input type="file" name="target" accept="image/jpeg" required />
			</label>
		</p>

		<div class="result">
			<p class="message"></p>

		<div class="image">
			<svg class="loading" width="60" height="60" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
				<circle cx="10" cy="10" r="9" fill="none" stroke="#6c79f9" strokeWidth="2" strokeLinecap="round">
					<animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 10 10" to="360 10 10" dur="2s" repeatCount="indefinite" />
					<animate attributeName="stroke-dasharray" attributeType="XML" values="1, 55.5; 40, 55.5; 40, 55.5" dur="1.5s" repeatCount="indefinite" />
					<animate attributeName="stroke-dashoffset" attributeType="XML" values="0; -15.5; -55.5" dur="1.5s" repeatCount="indefinite" />
				</circle>
			</svg>
		</div>

		</div>
	</div>
	<script src="./static/util.js"></script>
	<script>
		const CATEGORIES = [{"supercategory": "person", "id": 1, "name": "person"}, {"supercategory": "vehicle", "id": 2, "name": "bicycle"}, {"supercategory": "vehicle", "id": 3, "name": "car"}, {"supercategory": "vehicle", "id": 4, "name": "motorcycle"}, {"supercategory": "vehicle", "id": 5, "name": "airplane"}, {"supercategory": "vehicle", "id": 6, "name": "bus"}, {"supercategory": "vehicle", "id": 7, "name": "train"}, {"supercategory": "vehicle", "id": 8, "name": "truck"}, {"supercategory": "vehicle", "id": 9, "name": "boat"}, {"supercategory": "outdoor", "id": 10, "name": "traffic light"}, {"supercategory": "outdoor", "id": 11, "name": "fire hydrant"}, {"supercategory": "outdoor", "id": 13, "name": "stop sign"}, {"supercategory": "outdoor", "id": 14, "name": "parking meter"}, {"supercategory": "outdoor", "id": 15, "name": "bench"}, {"supercategory": "animal", "id": 16, "name": "bird"}, {"supercategory": "animal", "id": 17, "name": "cat"}, {"supercategory": "animal", "id": 18, "name": "dog"}, {"supercategory": "animal", "id": 19, "name": "horse"}, {"supercategory": "animal", "id": 20, "name": "sheep"}, {"supercategory": "animal", "id": 21, "name": "cow"}, {"supercategory": "animal", "id": 22, "name": "elephant"}, {"supercategory": "animal", "id": 23, "name": "bear"}, {"supercategory": "animal", "id": 24, "name": "zebra"}, {"supercategory": "animal", "id": 25, "name": "giraffe"}, {"supercategory": "accessory", "id": 27, "name": "backpack"}, {"supercategory": "accessory", "id": 28, "name": "umbrella"}, {"supercategory": "accessory", "id": 31, "name": "handbag"}, {"supercategory": "accessory", "id": 32, "name": "tie"}, {"supercategory": "accessory", "id": 33, "name": "suitcase"}, {"supercategory": "sports", "id": 34, "name": "frisbee"}, {"supercategory": "sports", "id": 35, "name": "skis"}, {"supercategory": "sports", "id": 36, "name": "snowboard"}, {"supercategory": "sports", "id": 37, "name": "sports ball"}, {"supercategory": "sports", "id": 38, "name": "kite"}, {"supercategory": "sports", "id": 39, "name": "baseball bat"}, {"supercategory": "sports", "id": 40, "name": "baseball glove"}, {"supercategory": "sports", "id": 41, "name": "skateboard"}, {"supercategory": "sports", "id": 42, "name": "surfboard"}, {"supercategory": "sports", "id": 43, "name": "tennis racket"}, {"supercategory": "kitchen", "id": 44, "name": "bottle"}, {"supercategory": "kitchen", "id": 46, "name": "wine glass"}, {"supercategory": "kitchen", "id": 47, "name": "cup"}, {"supercategory": "kitchen", "id": 48, "name": "fork"}, {"supercategory": "kitchen", "id": 49, "name": "knife"}, {"supercategory": "kitchen", "id": 50, "name": "spoon"}, {"supercategory": "kitchen", "id": 51, "name": "bowl"}, {"supercategory": "food", "id": 52, "name": "banana"}, {"supercategory": "food", "id": 53, "name": "apple"}, {"supercategory": "food", "id": 54, "name": "sandwich"}, {"supercategory": "food", "id": 55, "name": "orange"}, {"supercategory": "food", "id": 56, "name": "broccoli"}, {"supercategory": "food", "id": 57, "name": "carrot"}, {"supercategory": "food", "id": 58, "name": "hot dog"}, {"supercategory": "food", "id": 59, "name": "pizza"}, {"supercategory": "food", "id": 60, "name": "donut"}, {"supercategory": "food", "id": 61, "name": "cake"}, {"supercategory": "furniture", "id": 62, "name": "chair"}, {"supercategory": "furniture", "id": 63, "name": "couch"}, {"supercategory": "furniture", "id": 64, "name": "potted plant"}, {"supercategory": "furniture", "id": 65, "name": "bed"}, {"supercategory": "furniture", "id": 67, "name": "dining table"}, {"supercategory": "furniture", "id": 70, "name": "toilet"}, {"supercategory": "electronic", "id": 72, "name": "tv"}, {"supercategory": "electronic", "id": 73, "name": "laptop"}, {"supercategory": "electronic", "id": 74, "name": "mouse"}, {"supercategory": "electronic", "id": 75, "name": "remote"}, {"supercategory": "electronic", "id": 76, "name": "keyboard"}, {"supercategory": "electronic", "id": 77, "name": "cell phone"}, {"supercategory": "appliance", "id": 78, "name": "microwave"}, {"supercategory": "appliance", "id": 79, "name": "oven"}, {"supercategory": "appliance", "id": 80, "name": "toaster"}, {"supercategory": "appliance", "id": 81, "name": "sink"}, {"supercategory": "appliance", "id": 82, "name": "refrigerator"}, {"supercategory": "indoor", "id": 84, "name": "book"}, {"supercategory": "indoor", "id": 85, "name": "clock"}, {"supercategory": "indoor", "id": 86, "name": "vase"}, {"supercategory": "indoor", "id": 87, "name": "scissors"}, {"supercategory": "indoor", "id": 88, "name": "teddy bear"}, {"supercategory": "indoor", "id": 89, "name": "hair drier"}, {"supercategory": "indoor", "id": 90, "name": "toothbrush"}];

		const imageContainer = document.querySelector('.image');

		function onFileInput(event) {
			const selectedfile = event.target.files;
		    if (selectedfile.length > 0) {
				const [imageFile] = selectedfile;
				const fileReader = new FileReader();
				fileReader.onload = () => {
					const srcData = fileReader.result;
					removeImage();
					removeBox();
					hideMessage();
					appendImage(srcData);
					getInference(srcData);
				};
				fileReader.readAsDataURL(imageFile);
			}
		}

		function appendImage(srcData) {
			const img = document.createElement('img');
			img.src = srcData;
			imageContainer.appendChild(img);
			document.querySelector('.result').classList.add('on');
		}

		function removeImage() {
			const target = imageContainer.querySelector('img');
			if (!target) {
				return;
			}
			imageContainer.removeChild(target);
			document.querySelector('.result').classList.remove('on');
		}

		function getInference(image) {
			showLoading();

			const url = document.querySelector('[name=endpoint]').value;
			const token = document.querySelector('[name=token]').value;

			fetch(url, {
				headers: {
					'Content-Type': 'application/json',
					authorization: `bearer ${token}`,
				},
				method: 'POST',
				body: JSON.stringify({"parameters": {"content_type": "pd"}, "inputs": [{"name": "image_data", "shape": [1], "datatype": "BYTES", "data": [image.split('base64,')[1]]}]}),
			}).then(async res => {
				if (!res.ok) {
					const result = await res.json();

					// FIXME: RWAY-2556
					if (res.status === 401) {
						throw new Error(result);
					}

					// FIXME: RWAY-2556
					const json = new Function(`return ${result}`)()

					throw new Error(json.message || json);
				}

				return res.json();
			}).then(render).catch(err => {
				showMessage(err, 'fail');
				hideLoading();
			});
		}

		function parse(ascii, type) {
			const str = atob(ascii);
			// https://stackoverflow.com/questions/41903504/converting-a-string-of-packed-bytes-into-an-array-of-floats-in-javascript
			const bytes = Uint8Array.from(str, c => c.charCodeAt(0));
			const floats = type === 'LABEL' ? new BigInt64Array(bytes.buffer) : new Float32Array(bytes.buffer);
			return floats;
		}

		function appendBox(object) {
			const box = document.createElement('div');
			box.classList.add('object');
			box.classList.add(`color${Number(object.label) % 9 + 1}`);
			box.style.left = `${object.box[0] * 100}%`;
			box.style.top = `${object.box[1] * 100}%`;
			box.style.width = `${(object.box[2] - object.box[0]) * 100}%`;
			box.style.height = `${(object.box[3] - object.box[1]) * 100}%`;
			box.innerHTML = `<span>${CATEGORIES.find(c => c.id === Number(object.label)).name} (${object.score.toFixed(2)})</span>`;
			imageContainer.appendChild(box)
		}

		function removeBox() {
			const box = imageContainer.querySelectorAll('div');
			[...box].forEach(b => {
				imageContainer.removeChild(b);
			});
		}

		function getImageDimension() {
			const img = imageContainer.querySelector('img');
			return {
				width: img.naturalWidth,
				height: img.naturalHeight,
			}
		}

		function render(result) {
			hideLoading();

			if (!result.outputs) {
				return;
			}

			const boxes = parse(result.outputs[0].data[0], 'BOX');
			const labels = parse(result.outputs[1].data[0], 'LABEL');
			const scores = parse(result.outputs[2].data[0], 'SCORE');
			const { width, height } = getImageDimension();

			const objects = [];
			scores.forEach((score, index) => {
				if (score < 0.9) {
					return;
				}
				objects.push({
					// x0, y0, x1, y1
					box: [
						boxes[index * 4] / width,
						boxes[index * 4 + 1] / height,
						boxes[index * 4 + 2] / width,
						boxes[index * 4 + 3] / height
					],
					label: labels[index],
					score,
				});
			});

			objects.forEach(appendBox);
			showMessage(`Detect ${objects.length} object${objects.length > 1 ? 's' : ''}.`, 'pass');
		}

		const file = document.querySelector('input[type=file]');
		file.addEventListener('input', onFileInput);
	</script>
</body>
</html>
